name: Weekly Test Summary

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:
    inputs:
      days_back:
        description: "Number of days to look back for comparison"
        required: false
        default: "7"

permissions:
  contents: write
  issues: write
  pull-requests: read

jobs:
  generate-summary:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      TURBO_TELEMETRY_DISABLED: 1

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Collect metrics
        run: pnpm metrics:collect
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Generate weekly summary
        id: summary
        run: |
          DAYS_BACK="${{ github.event.inputs.days_back || '7' }}"
          pnpm metrics:weekly --days "$DAYS_BACK" > weekly-summary.md
          echo "summary_file=weekly-summary.md" >> "$GITHUB_OUTPUT"

      - name: Upload summary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: weekly-test-summary
          path: weekly-summary.md
          retention-days: 90

      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('weekly-summary.md', 'utf8');

            const today = new Date().toISOString().split('T')[0];
            const title = `Weekly Test-Readiness Summary - ${today}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: summary,
              labels: ['testing', 'weekly-summary', 'automated']
            });

      - name: Comment on open PRs with blockers (if any)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summaryContent = fs.readFileSync('weekly-summary.md', 'utf8');

            // Check if there are blockers
            if (!summaryContent.includes('Coverage Threshold Blockers')) {
              console.log('No blockers found, skipping PR comments');
              return;
            }

            // Get open PRs
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 10
            });

            // Extract blocker section
            const blockerSection = summaryContent.split('## ⚠️ Coverage Threshold Blockers')[1]?.split('##')[0] || '';

            if (pulls.length > 0 && blockerSection) {
              const comment = `## ⚠️ Weekly Test Coverage Alert\n\nThe latest test coverage summary shows some workspaces are below their thresholds:\n\n${blockerSection}\n\nPlease consider adding tests if your changes affect these areas.\n\nFull summary: [Weekly Test Summary](../actions/runs/${{ github.run_id }})`;

              for (const pull of pulls) {
                // Only comment on PRs that don't already have this week's summary
                const { data: comments } = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pull.number
                });

                const hasRecentSummary = comments.some(c =>
                  c.body?.includes('Weekly Test Coverage Alert') &&
                  new Date(c.created_at) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
                );

                if (!hasRecentSummary) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pull.number,
                    body: comment
                  });
                }
              }
            }
