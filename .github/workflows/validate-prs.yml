name: Validate PRs

on:
  pull_request:
    branches: [main]

env:
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  sync-migrations:
    name: Sync Prisma migrations to Supabase
    runs-on: ubuntu-latest
    # Only run if Prisma migrations changed
    if: |
      github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for Prisma migration changes
        id: check-migrations
        run: |
          # Check if any Prisma migrations were added/modified
          CHANGED=$(git diff --name-only origin/main...HEAD -- 'packages/database/prisma/migrations/' | wc -l | tr -d ' ')
          echo "migrations_changed=$CHANGED" >> $GITHUB_OUTPUT
          if [ "$CHANGED" -gt 0 ]; then
            echo "Prisma migrations changed: $CHANGED files"
          else
            echo "No Prisma migration changes detected"
          fi

      - name: Sync Prisma migrations to Supabase format
        if: steps.check-migrations.outputs.migrations_changed != '0'
        run: |
          chmod +x ./tooling/scripts/src/supabase/sync-prisma-to-supabase.sh
          ./tooling/scripts/src/supabase/sync-prisma-to-supabase.sh --verbose

      - name: Check for new Supabase migrations
        if: steps.check-migrations.outputs.migrations_changed != '0'
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain supabase/migrations/)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "New Supabase migrations to commit:"
            git status --short supabase/migrations/
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No new Supabase migrations needed"
          fi

      - name: Commit synced migrations
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add supabase/migrations/
          git commit -m "chore(database): sync Prisma migrations to Supabase format

          Automatically synced by CI to enable Supabase preview branch validation.

          ðŸ¤– Generated with GitHub Actions"
          if ! git push; then
            echo "::warning::Failed to push synced migrations. This may be due to branch protection rules."
            echo "::warning::Please run './tooling/scripts/src/supabase/sync-prisma-to-supabase.sh' locally and commit the changes."
            exit 1
          fi

  schema-drift:
    name: Detect schema drift
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: drift_check
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      # Schema uses POSTGRES_PRISMA_URL and POSTGRES_URL_NON_POOLING
      POSTGRES_PRISMA_URL: postgresql://postgres:postgres@localhost:5432/drift_check
      POSTGRES_URL_NON_POOLING: postgresql://postgres:postgres@localhost:5432/drift_check
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - uses: pnpm/action-setup@v4
      - name: Install dependencies
        run: pnpm install
      - name: Check for schema drift
        run: |
          echo "Checking if schema.prisma matches migration history..."
          cd packages/database

          # Apply all migrations to the temporary database
          echo "Applying migrations to temporary database..."
          pnpm prisma migrate deploy

          # Generate a diff between the current database (after migrations) and the schema
          # If there's drift, this will output SQL that would be needed to sync
          echo "Comparing database state to schema.prisma..."
          DRIFT=$(pnpm prisma migrate diff \
            --from-schema-datasource prisma/schema.prisma \
            --to-schema-datamodel prisma/schema.prisma \
            --script 2>&1) || true

          # Filter out Prisma upgrade notifications (they appear as box-drawing characters)
          # Only keep lines that look like SQL or the empty migration message
          DRIFT_CLEAN=$(echo "$DRIFT" | grep -v "^â”Œ\|^â”‚\|^â””\|Update available\|pris.ly\|npm i" || true)

          # Check if there's any drift (look for actual SQL statements beyond empty migration comment)
          # An empty migration only has "-- This is an empty migration."
          HAS_DRIFT=$(echo "$DRIFT_CLEAN" | grep -v "^--\|^$" | head -1 || true)

          if [ -n "$HAS_DRIFT" ]; then
            echo "::error::Schema drift detected! The schema.prisma file differs from the migration history."
            echo ""
            echo "This typically happens when 'prisma db push' was used instead of 'prisma migrate dev'."
            echo ""
            echo "To fix this, create a migration:"
            echo "  pnpm --filter @repo/database migrate dev --name <migration-name>"
            echo ""
            echo "Detected drift:"
            echo "$DRIFT_CLEAN"
            exit 1
          else
            echo "No schema drift detected. Schema matches migration history."
          fi

  lint:
    name: Lint code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Biome
        uses: biomejs/setup-biome@v2
        with:
          version: latest
      - name: Run Biome
        run: biome ci .
  e2e:
    name: Run e2e tests
    timeout-minutes: 60
    runs-on: ubuntu-latest
    # Only run E2E tests on PRs from the same repo (not forks) since we need secrets
    if: github.event.pull_request.head.repo.full_name == github.repository
    env:
      BETTER_AUTH_SECRET: ci-test-secret-not-for-production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - uses: pnpm/action-setup@v4
      - name: Install dependencies
        run: pnpm install && pnpm --filter database generate
      - name: Wait for Supabase preview and get credentials
        id: supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          echo "Waiting for Supabase preview branch to be ready..."
          echo "Branch: ${{ github.head_ref }}"

          # Wait for Supabase branch and get database credentials using ESM
          node --input-type=module -e "
            import { createSupabaseClientFromEnv } from './tooling/scripts/src/supabase/api-client.mjs';
            import fs from 'fs';

            const gitBranch = '${{ github.head_ref }}';
            const client = createSupabaseClientFromEnv();

            // Wait up to 15 minutes for the branch to be ready
            const branch = await client.waitForBranch(gitBranch, {
              timeoutMs: 900000,  // 15 minutes
              initialDelay: 10000,
              maxDelay: 30000
            });

            const creds = await client.getBranchCredentials(branch);

            // Output for GitHub Actions
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'pooler_url=' + creds.poolerUrl + '\n');
            fs.appendFileSync(process.env.GITHUB_OUTPUT, 'direct_url=' + creds.directUrl + '\n');
            console.log('Database credentials retrieved successfully');
          " || {
            echo "::warning::Supabase preview not ready after 15 minutes, E2E tests will be skipped"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          }
      - name: Run Playwright tests
        if: steps.supabase.outputs.skip != 'true'
        env:
          POSTGRES_PRISMA_URL: ${{ steps.supabase.outputs.pooler_url }}
          POSTGRES_URL_NON_POOLING: ${{ steps.supabase.outputs.direct_url }}
        run: pnpm --filter web e2e:ci
      - name: Skip notice
        if: steps.supabase.outputs.skip == 'true'
        run: echo "::notice::E2E tests skipped - Supabase preview branch not ready"
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() && steps.supabase.outputs.skip != 'true' }}
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 30
      - name: Upload Playwright Screenshots
        uses: actions/upload-artifact@v4
        if: ${{ failure() && steps.supabase.outputs.skip != 'true' }}
        with:
          name: playwright-screenshots
          path: apps/web/test-results/**/screenshots/
          retention-days: 7
          if-no-files-found: ignore
      - name: Upload Playwright Videos
        uses: actions/upload-artifact@v4
        if: ${{ failure() && steps.supabase.outputs.skip != 'true' }}
        with:
          name: playwright-videos
          path: apps/web/test-results/**/videos/
          retention-days: 7
          if-no-files-found: ignore
      - name: Upload Playwright Traces
        uses: actions/upload-artifact@v4
        if: ${{ failure() && steps.supabase.outputs.skip != 'true' }}
        with:
          name: playwright-traces
          path: apps/web/test-results/**/trace.zip
          retention-days: 7
          if-no-files-found: ignore
  type-check:
    name: TypeScript type-check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - uses: pnpm/action-setup@v4
      - name: Install dependencies
        run: pnpm install && pnpm --filter database generate
      - name: Build content-collections
        run: pnpm --filter web build
        env:
          SKIP_ENV_VALIDATION: "1"
      - name: Run type-check
        run: pnpm --filter web run type-check

  tests:
    name: Run workspace tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - uses: pnpm/action-setup@v4
      - name: Install dependencies
        run: pnpm install && pnpm --filter database generate
      - name: Run unit tests
        env:
          TURBO_TELEMETRY_DISABLED: "1"
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: pnpm test:ci
