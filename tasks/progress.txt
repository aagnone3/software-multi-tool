## Codebase Patterns

- When deleting an app, also delete related skills, proxy routes, and update CORS configuration
- When removing a package, also remove related npm scripts, imports, test files, and configuration
- Job processing now handled by Inngest functions in apps/web/inngest/functions/
- Job maintenance (stuck jobs, cleanup) still uses cron at /api/cron/job-maintenance
- Use consistent table formatting in markdown: align pipes with spaces for compact style
- Add language specifiers to all fenced code blocks (use `text` for directory trees)
- Pre-commit hooks auto-fix markdown but may fail on first attempt; re-stage and retry
- Markdown headings must be unique within a document (markdownlint MD024)—use prose paragraphs instead of repeated sub-headings for comparison sections
- Vercel KV was deprecated Dec 2024, replaced by Upstash Redis in Marketplace
- MD036 lint error: Don't use `**bold text**` as standalone lines (looks like headings)—use actual headings or inline emphasis within prose
- Job processors live in `packages/api/modules/<name>/lib/processor.ts` with registration in `register.ts`
- Inngest client initialization: use `new EventSchemas().fromRecord<{ ... }>()` for typed events
- Inngest serve endpoint: export `{ GET, POST, PUT }` from `serve({ client, functions })` in Next.js route
- Inngest event naming convention: `"jobs/<job-name>.<action>"` (e.g., `jobs/news-analyzer.requested`)
- Inngest step serialization converts Date objects to strings—re-fetch database records inside each step to get proper types
- Use `as Prisma.InputJsonValue` cast when passing Inngest step results to database functions
- For long-running jobs (e.g., speaker-separation), use AssemblyAI SDK's `submit()` + `waitUntilReady()` pattern instead of blocking `transcribe()`
- AssemblyAI `waitUntilReady()` handles polling internally—set pollingInterval (5s) and pollingTimeout (2hr to match Inngest step limit)
- Export shared functions from module index.ts if they need to be imported by Inngest functions (e.g., `downloadAudioFromStorage`)
- Supabase Realtime client lives in `apps/web/modules/realtime/` with typed broadcast and presence helpers
- Use `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` for client-side Supabase (browser-safe)
- Supabase Realtime presence handlers return `Presence<T>[]` types—cast through `unknown` when needed for TypeScript
- Echo/heartbeat for Supabase Realtime: use broadcast channels with `subscribeToEcho`, `sendEchoMessage`, `startHeartbeat`
- React hooks for realtime: `useRealtimeEcho` and `useRealtimeBroadcast` handle subscription lifecycle
- Path aliases: add `@realtime` to tsconfig.json paths for clean imports
- GitHub PR label `preview` triggers preview deployments (renamed from `render-preview`)
- Preview sync workflow only syncs Supabase→Vercel now (Render removed)

- Documentation updates (CLAUDE.md, skills) should include new components like Inngest and Supabase Realtime
- When updating skill documentation, rename duplicate headings (e.g., "Key Files" → "Inngest Module Files")

---

## 2026-01-30 - US-021

- Ran full test suite to verify migration completion
- Unit tests: All 15 workspaces passed, 524 tests in @repo/web alone
  - `pnpm test` completed successfully with all tasks passing
  - No test failures, only expected log output from error handling tests
- Integration tests: All 117 database integration tests passed
  - RLS tests: 97 tests (sensitive tables, auth tables, org membership, application data)
  - Credit balance tests: 10 tests
  - Tool tests: 10 tests
  - Docker/Testcontainers running successfully
- TypeScript: `pnpm --filter web run type-check` passes with no errors
- E2E tests: Require running dev server for manual verification
  - Playwright tests exist in `apps/web/tests/*.spec.ts`
  - 9 test files covering auth, onboarding, billing, home, smoke tests, etc.
- Files changed:
  - `tasks/prd.json` (updated US-021 passes: true)
- **Learnings for future iterations:**
  - Integration tests use Testcontainers and require Docker running
  - The `pnpm test` command runs unit tests; integration tests need `--dir tests` flag
  - Node.js v24 shows "Unsupported engine" warnings but tests still pass
  - E2E tests require a running Next.js dev server on port 3500

---

## 2026-01-30 - US-019

- Updated architecture skill with comprehensive Inngest and Supabase Realtime documentation
- SKILL.md changes:
  - Updated main architecture diagram to show Inngest and Supabase Realtime as separate components
  - Added "Background Jobs (Inngest)" section with:
    - Architecture diagram (event → queue → function → database flow)
    - Inngest module files table
    - Job functions table (all 8 processors with durations)
    - 3-step function pattern explanation with code example
    - Long-running job guidance
    - Local development instructions
  - Expanded "Real-time Updates (Supabase Realtime)" section with:
    - Realtime module files table
    - Channel types table (broadcast, presence, postgres_changes)
    - Usage example with @realtime alias
    - Path alias documentation
  - Updated deployment table to include Inngest
  - Updated quick deployment reference with Jobs column
- deployment.md changes:
  - Added architecture overview diagram showing Vercel + Inngest + Supabase
  - Added "Background Jobs: Inngest" section with environment table
  - Added "Real-time: Supabase" section
  - Added environment variables sections for both
- examples.md changes:
  - Added "Adding Background Jobs (Inngest)" section with step-by-step guide
  - Added "Adding Real-time Features (Supabase)" section with broadcast and presence examples
  - Updated table of contents
- Files changed:
  - `.claude/skills/architecture/SKILL.md`
  - `.claude/skills/architecture/deployment.md`
  - `.claude/skills/architecture/examples.md`
- **Learnings for future iterations:**
  - Markdown headings must be unique within a document (MD024)—renamed "Key Files" to "Inngest Module Files" and "Realtime Module Files"
  - Architecture skills should document both infrastructure components AND code locations
  - Examples are valuable for future developers/agents to understand patterns

---

## 2026-01-30 - US-018

- Updated CLAUDE.md architecture section to document new infrastructure:
  - Added "Background Jobs (Inngest)" section with functions, client, and serve endpoint locations
  - Added "Real-time Updates (Supabase Realtime)" section with module location and @realtime alias
  - Updated skill documentation list to include background jobs and real-time updates
- Fixed architecture skill SKILL.md frontmatter description:
  - Removed outdated "hybrid backend (Next.js + Fastify)" reference
  - Now describes "Next.js serverless backend" with Inngest and Supabase Realtime
- No Render or api-server references found in CLAUDE.md (already cleaned in prior stories US-015, US-016)
- Files changed:
  - `CLAUDE.md` (added 20 lines documenting Inngest and Supabase Realtime)
  - `.claude/skills/architecture/SKILL.md` (updated description line)
- **Learnings for future iterations:**
  - Architecture documentation should be updated whenever new infrastructure is added (not just removed)
  - Skill frontmatter descriptions are visible to Claude Code and should accurately reflect current architecture
  - CLAUDE.md is the primary entry point—ensure new major systems are documented there

---

## 2026-01-30 - US-016

- Deleted `apps/api-server/` directory with all source files:
  - index.ts, server.ts, logger.ts, env.ts
  - All tests (server.test.ts, websocket.test.ts, etc.)
  - Scripts (ensure-node-version.sh, smoke-test.cjs/mjs)
  - Configuration (package.json, tsconfig.json, vitest.config.ts)
- Deleted `apps/web/app/api/proxy/` directory:
  - `[...path]/route.ts` - No longer needed without api-server
  - `lib.ts` and `lib.test.ts` - Proxy utilities
- Deleted `.claude/skills/async-jobs/` directory:
  - SKILL.md, creating-processors.md, troubleshooting.md
  - pg-boss worker documentation no longer relevant
- Deleted `.claude/skills/api-proxy/` directory:
  - SKILL.md - Preview proxy documentation no longer needed
- Updated `packages/api/lib/cors.ts`:
  - Removed `process.env.RENDER` environment check
  - Simplified comment for Vercel preview environments
- Updated `.claude/skills/architecture/SKILL.md`:
  - Removed api-server from Quick Reference table
  - Removed api-server from Monorepo Structure
  - Replaced "Hybrid Backend Architecture" with simplified "Backend Architecture"
  - Updated diagram to show single Next.js + Supabase architecture
  - Removed API Proxy section
  - Updated storage reference from S3 to Supabase
  - Updated deployment table (removed API column)
  - Removed api-proxy from Related Skills
- Updated `.claude/skills/git-worktrees/environment-setup.md`:
  - Removed API Server port range from table
  - Removed "API Server Environment" section
  - Removed database URL consistency check section (web+api sync)
  - Simplified storage troubleshooting (web app only)
- Updated `.claude/commands/dev:start-apps.md` and `dev:stop-apps.md`:
  - Removed all api-server port configuration
  - Removed API port allocation and verification
  - Simplified examples to show only web app ports
- Updated `CLAUDE.md`:
  - Removed "Bundling Best Practices (api-server)" section
  - Removed "API Server Auto-Switch" Node.js version note
- Updated `tooling/scripts/src/worktree-setup.sh`:
  - Removed api-server .env.local copying
  - Removed api-server port allocation
  - Removed CORS_ORIGIN and BETTER_AUTH_URL updates
  - Removed api-server Supabase storage configuration
  - Removed api_port from success output
- Updated `tooling/scripts/src/worktree-port.sh`:
  - Removed api-server offset example from usage
  - Removed api-server port range documentation
  - Cleaned up offset comment
- Cleaned .next cache to regenerate types (old proxy route reference)
- Files changed: 33 files changed, 55 insertions(+), 3859 deletions(-)
- **Learnings for future iterations:**
  - When deleting an app, also clean up related skills (api-proxy, async-jobs)
  - Next.js caches type references in .next/types/—delete .next when removing routes
  - pnpm-workspace.yaml uses globs (apps/*) so no manual removal needed
  - turbo.json uses generic task definitions so no app-specific entries to remove
  - Architecture skill should reflect actual deployment model (single vs hybrid backend)

---

## 2026-01-30 - US-015

- Deleted Render-related packages and scripts:
  - `packages/render/` directory (Render API client)
  - `tooling/scripts/src/render/` directory (Render CLI helper)
  - `.claude/skills/render/` directory (Render deployment skill)
  - `tooling/scripts/src/preview-sync/github-checks.mjs` and `.test.ts` (Render GitHub Check integration)
  - `.claude/skills/debugging/platform-render.md` (Render debugging guide)
- Updated preview-sync script to remove all Render code:
  - Removed Render API client import
  - Removed RENDER_API_KEY environment variable
  - Removed all Render service waiting and syncing logic
  - Removed GitHub Check creation (was for Render deployment status)
  - Now only syncs Supabase → Vercel (database credentials and API keys)
- Removed render script from `tooling/scripts/package.json`
- Updated skill documentation:
  - `debugging/SKILL.md`: Removed Render from description, quick fixes, error patterns, environment reference
  - `cicd/SKILL.md`: Removed Render from description, architecture diagram, env sync flow, GitHub secrets
  - `cicd/troubleshooting.md`: Removed Render preview troubleshooting section
- Removed API_SERVER_URL and NEXT_PUBLIC_API_SERVER_URL from `apps/web/.env.local.example`
- Files changed:
  - 21 files changed, 76 insertions(+), 4377 deletions(-)
- **Learnings for future iterations:**
  - When removing a platform, search for references in skill documentation, not just code
  - Preview-sync script had significant Render-specific code (API client, GitHub Checks, service syncing)
  - API_SERVER_URL env vars existed to point to Render preview URLs—no longer needed
  - Architecture and api-proxy skills still have some Render references—will be cleaned up in US-019

---

## 2026-01-30 - US-013

- Removed pg-boss package from all 3 package.json files:
  - `apps/api-server/package.json`
  - `packages/api/package.json`
  - `packages/database/package.json`
- Deleted pg-boss specific files:
  - `apps/api-server/src/lib/pg-boss.ts` and `pg-boss.test.ts`
  - `apps/api-server/src/workers/` directory (index.ts, types.ts, workers.test.ts)
  - `packages/database/scripts/init-pgboss-schema.mjs` and `verify-pgboss-schema.mjs`
  - `packages/api/modules/jobs/lib/queue.ts` and `queue.test.ts`
- Updated source files to remove pg-boss references:
  - `apps/api-server/src/index.ts`: Removed worker registration and pg-boss startup
  - `apps/api-server/src/config/env.ts`: Removed USE_PGBOSS_WORKERS env var
  - `packages/api/modules/jobs/lib/job-config.ts`: Updated docs to reference Inngest
  - `packages/api/modules/jobs/lib/job-runner.ts`: Removed deprecated functions (processNextJob, processAllPendingJobs, retryFailedJobs, reconcileJobStates)
  - `packages/api/modules/jobs/procedures/create-job.ts`: Removed submitJobToQueue call
  - `apps/web/app/api/cron/job-maintenance/route.ts`: Removed reconcileJobStates call
- Updated test files:
  - `packages/api/modules/jobs/lib/job-config.test.ts`: Removed ARCHIVE_CONFIG and WORKER_CONFIG tests
  - `packages/api/modules/jobs/lib/job-runner.test.ts`: Removed deprecated function tests
  - `packages/api/modules/jobs/lib/processor-registry.test.ts`: Updated comment
- Removed pgboss:* npm scripts from packages/database/package.json
- Updated comments in postgres-test-harness.ts to remove pg-boss reference
- Ran pnpm install to update lockfile (-5 packages removed)
- Files changed:
  - 25 files changed, 83 insertions(+), 1580 deletions(-)
- **Learnings for future iterations:**
  - When removing a package dependency, grep for both the package name and related terminology (e.g., pg-boss and pgboss)
  - Deprecated no-op functions in previous story can be fully deleted in the package removal story
  - Check for npm scripts that reference the removed package
  - Comments mentioning the removed technology should be updated to reference the replacement
  - Pre-existing type errors in test fixtures don't need to be fixed as part of a package removal

---

## 2026-01-30 - US-012

- Created Prisma migration `20260130000940_drop_pgboss_schema` to drop all pg-boss infrastructure:
  - pgboss.version, pgboss.queue, pgboss.schedule, pgboss.subscription tables
  - pgboss.job partitioned table and all dynamically created partition tables
  - pgboss.archive table
  - pgboss.create_queue and pgboss.delete_queue functions
  - pgboss.job_state enum type
  - The entire pgboss schema itself
- Removed pgBossJobId column from tool_job table
- Updated Prisma schema:
  - Removed `schemas = ["pgboss", "public"]` multiSchema config (now just `["public"]`)
  - Removed all 6 pgboss models (archive, job, queue, schedule, subscription, version)
  - Removed job_state enum
- Updated job processing code to deprecate pg-boss functions:
  - `job-runner.ts`: reconcileJobStates now returns no-op with deprecation warning
  - `queue.ts`: submitJobToQueue and arePgBossWorkersActive now return no-ops with deprecation warnings
- Deleted pg-boss related tests:
  - `packages/database/tests/pgboss-schema.integration.test.ts`
  - `packages/api/modules/jobs/tests/job-lifecycle.integration.test.ts`
  - `packages/api/modules/jobs/tests/test-processors.ts`
  - `packages/api/modules/jobs/procedures/create-job.integration.test.ts`
- Updated unit tests:
  - `job-runner.test.ts`: Removed pg-boss reconciliation tests, added deprecation warning test
  - `queue.test.ts`: Simplified to test deprecated function behavior
- Synced migration to Supabase format at `supabase/migrations/20260130000940_drop_pgboss_schema.sql`
- Files changed:
  - `packages/database/prisma/migrations/20260130000940_drop_pgboss_schema/migration.sql` (new)
  - `packages/database/prisma/schema.prisma` (removed pgboss schema + models)
  - `packages/database/prisma/zod/index.ts` (regenerated, removed pgboss types)
  - `packages/api/modules/jobs/lib/job-runner.ts` (deprecated reconciliation)
  - `packages/api/modules/jobs/lib/queue.ts` (deprecated queue functions)
  - `packages/api/modules/jobs/lib/job-runner.test.ts` (updated tests)
  - `packages/api/modules/jobs/lib/queue.test.ts` (updated tests)
  - `supabase/migrations/20260130000940_drop_pgboss_schema.sql` (new)
  - Multiple test files deleted (see above)
- **Learnings for future iterations:**
  - pg-boss creates dynamic partition tables named `j<sha224(queue_name)>` that must be discovered and dropped
  - Use advisory lock (`pg_advisory_xact_lock`) in migrations for safe concurrent execution
  - Dropping multiSchema requires regenerating Prisma client—run `pnpm --filter @repo/database generate`
  - Pre-commit hooks may fail due to Biome formatting—re-stage fixed files and retry commit
  - Integration tests that reference removed infrastructure must be deleted, not just modified
  - Zod schemas are auto-generated—no manual updates needed, just regenerate

---

## 2026-01-29 - US-011

- WebSocket audit (US-004) found no production client code using WebSockets—implementation was unused scaffolding
- Added echo/heartbeat functionality to Supabase Realtime module as replacement:
  - `echo.ts`: `subscribeToEcho()`, `sendEchoMessage()`, `startHeartbeat()` for connection testing
  - `hooks.ts`: `useRealtimeEcho()` and `useRealtimeBroadcast()` React hooks
- Echo message structure matches old WebSocket pattern: `{ type: "echo", data: T, timestamp: string }`
- Heartbeat uses self-echo pattern via broadcast—sends ping, immediately sends pong, verifies receipt
- Added `@realtime` path alias to `apps/web/tsconfig.json` for clean imports
- Files changed:
  - `apps/web/modules/realtime/echo.ts` (new file)
  - `apps/web/modules/realtime/hooks.ts` (new file)
  - `apps/web/modules/realtime/index.ts` (updated exports)
  - `apps/web/tsconfig.json` (added @realtime path alias)
- **Learnings for future iterations:**
  - Supabase Realtime broadcast self-echoes—sender receives their own messages
  - Use `startHeartbeat()` for application-level health checks (Supabase handles transport-level internally)
  - React hooks with dynamic imports need cleanup patterns that handle Promise resolution
  - No existing WebSocket client code to migrate—acceptance criteria "Remove direct WebSocket connection code" is N/A

---

## 2026-01-29 - US-010

- Added `@supabase/supabase-js@2.91.1` to apps/web (matches packages/storage version)
- Created `apps/web/modules/realtime/` module with typed channel helpers:
  - `client.ts`: Supabase Realtime client singleton with broadcast and presence functions
  - `types.ts`: TypeScript interfaces for subscriptions, handlers, and message options
  - `index.ts`: Module exports
- Implemented typed functions for:
  - `subscribeToBroadcast()`: Subscribe to pub/sub broadcast messages
  - `broadcastMessage()`: Send broadcast messages to a channel
  - `subscribeToPresence()`: Track who's online with presence state
  - `getPresenceState()`: Get current presence state for a channel
  - `removeChannel()` / `removeAllChannels()`: Cleanup functions
- All functions are `"use client"` for browser-side usage
- Files changed:
  - `apps/web/package.json` (added @supabase/supabase-js dependency)
  - `apps/web/modules/realtime/client.ts` (new file)
  - `apps/web/modules/realtime/types.ts` (new file)
  - `apps/web/modules/realtime/index.ts` (new file)
  - `pnpm-lock.yaml` (updated)
- **Learnings for future iterations:**
  - Supabase Realtime requires `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` env vars
  - Presence event handlers return Supabase's `Presence<T>[]` type—use `as unknown as T[]` cast for proper typing
  - Module follows same pattern as analytics module—single index.ts re-exporting from submodules
  - WebSocket audit (US-004) noted no production code uses WebSockets—this realtime module is for future use

---

## 2026-01-29 - US-009

- Migrated all 6 remaining job processors from pg-boss to Inngest:
  - `invoice-processor`: Extracts structured data from invoices using Claude AI
  - `contract-analyzer`: Analyzes legal contracts for risks and terms using Claude AI
  - `feedback-analyzer`: Analyzes customer feedback for sentiment and themes using Claude AI
  - `expense-categorizer`: Categorizes business expenses for tax purposes using Claude AI
  - `meeting-summarizer`: Summarizes meeting transcripts and extracts action items using Claude AI
  - `gdpr-exporter`: Exports all user data for GDPR compliance
- All 6 functions follow the same 3-step pattern as news-analyzer:
  1. validate-job: Verify job exists
  2. process-<job>: Run processor logic (re-fetches job to avoid serialization issues)
  3. update-job-status: Mark job completed or failed
- Configured all functions with 3 retries and exponential backoff
- Updated serve endpoint to register all 8 functions (grouped by category: AI jobs, audio processing, GDPR)
- Files changed:
  - `apps/web/inngest/functions/invoice-processor.ts` (new file)
  - `apps/web/inngest/functions/contract-analyzer.ts` (new file)
  - `apps/web/inngest/functions/feedback-analyzer.ts` (new file)
  - `apps/web/inngest/functions/expense-categorizer.ts` (new file)
  - `apps/web/inngest/functions/meeting-summarizer.ts` (new file)
  - `apps/web/inngest/functions/gdpr-exporter.ts` (new file)
  - `apps/web/app/api/inngest/route.ts` (updated imports and functions array)
- **Learnings for future iterations:**
  - All processors export `process<Name>Job` from module index.ts (e.g., `processInvoiceJob`, `processContractJob`)
  - Event schemas already defined in client.ts from US-006—no changes needed there
  - Pattern is highly consistent: validate → process → update-status, with re-fetch in process step
  - All 7 "short" jobs (everything except speaker-separation) can use simple 3-step pattern

---

## 2026-01-29 - US-008

- Created `apps/web/inngest/functions/speaker-separation.ts` with 5 Inngest steps:
  1. validate-job: Verify job exists and get audio URL
  2. upload-to-assemblyai: Download from storage, upload to AssemblyAI
  3. submit-transcription: Submit request (returns immediately with transcript ID)
  4. poll-transcription: Poll until complete (handles 5-60+ min transcriptions)
  5. process-and-save: Format results and update database
- Uses AssemblyAI SDK's async pattern: `submit()` returns immediately, `waitUntilReady()` polls
- Configured with 3 retries and 2-hour polling timeout
- Registered function in serve endpoint at `apps/web/app/api/inngest/route.ts`
- Added `downloadAudioFromStorage` export to speaker-separation module index
- Added assemblyai@4.22.1 as direct dependency in web app
- Files changed:
  - `apps/web/inngest/functions/speaker-separation.ts` (new file)
  - `apps/web/app/api/inngest/route.ts` (added speakerSeparation import and registration)
  - `packages/api/modules/speaker-separation/index.ts` (added downloadAudioFromStorage export)
  - `apps/web/package.json` (added assemblyai dependency)
  - `pnpm-lock.yaml` (updated)
- **Learnings for future iterations:**
  - AssemblyAI SDK has `submit()` for async transcription (returns immediately with ID)
  - `waitUntilReady()` handles all polling logic internally—no need to implement custom polling
  - pollingTimeout should match Inngest step timeout (2 hours = 7200000ms)
  - Must define interface for step return types (e.g., TranscriptResult) for proper TypeScript typing
  - Inngest step returns are JSON-serialized, so define explicit interfaces rather than relying on inference
  - Add required dependencies (assemblyai) directly to web app, not just internal packages

---

## 2026-01-29 - US-007

- Created `apps/web/inngest/functions/news-analyzer.ts` with full job migration
- Function uses 3 Inngest steps: validate-job, process-analysis, update-job-status
- Configured with 3 retries and exponential backoff via Inngest retry config
- Re-fetches job from database inside processing step to avoid Inngest JSON serialization issues with dates
- Registered function in serve endpoint at `apps/web/app/api/inngest/route.ts`
- Files changed:
  - `apps/web/inngest/functions/news-analyzer.ts` (new file)
  - `apps/web/app/api/inngest/route.ts` (added newsAnalyzer import and registration)
- **Learnings for future iterations:**
  - Inngest steps return JSON-serialized data—Date objects become strings
  - Re-fetch database records inside steps to get proper TypeScript types
  - News analyzer job completes well under serverless timeout (< 2 min typically)
  - Function registration is in route.ts serve() functions array, not in client.ts
  - Existing processor logic can be reused directly—just wrap with Inngest function

---

## 2026-01-29 - US-006

- Installed `inngest@3.49.3` package to apps/web
- Created `apps/web/inngest/client.ts` with typed event schemas for all 8 job types
- Created `apps/web/app/api/inngest/route.ts` serve endpoint (empty functions array for now)
- Added `INNGEST_EVENT_KEY` and `INNGEST_SIGNING_KEY` to `.env.local.example`
- Files changed:
  - `apps/web/package.json` (added inngest dependency)
  - `apps/web/inngest/client.ts` (new file)
  - `apps/web/app/api/inngest/route.ts` (new file)
  - `apps/web/.env.local.example` (added Inngest env vars)
  - `pnpm-lock.yaml` (updated)
- **Learnings for future iterations:**
  - Inngest SDK v3.49.3 has full TypeScript support with `EventSchemas` class
  - Event data types define the payload structure for each job trigger
  - Functions array in serve() will be populated as jobs are migrated in US-007, US-008, US-009
  - Local dev dashboard: `npx inngest-cli@latest dev` starts at http://localhost:8288
  - Inngest auto-detects environment from Vercel Marketplace integration (no manual key management needed in production)

---

## 2026-01-29 - US-005

- Created `docs/research/pgboss-jobs-audit.md` with comprehensive audit of all 8 job processors
- Documented: news-analyzer, speaker-separation, invoice-processor, contract-analyzer, feedback-analyzer, expense-categorizer, meeting-summarizer, gdpr-exporter
- Each job documented with queue name, processor location, trigger mechanism, AI model used, expected duration
- Identified speaker-separation as the only job exceeding serverless timeout limits (5-60+ minutes)
- 7 of 8 jobs are safe for direct Inngest migration
- Provided recommended Inngest steps pattern for speaker-separation (using AssemblyAI polling or webhooks)
- Files changed: `docs/research/pgboss-jobs-audit.md` (new file)
- **Learnings for future iterations:**
  - Only speaker-separation needs Inngest steps—all other jobs finish well under 10 minutes
  - AssemblyAI transcription time depends on audio length (roughly 0.5x to 1x real-time)
  - Job configuration centralized in `packages/api/modules/jobs/lib/job-config.ts`
  - pg-boss schema created by Prisma migration (PRA-91), not by pg-boss itself
  - Jobs use `withTimeout()` wrapper for application-level timeout (10 min default)
  - gdpr-exporter may edge near limits for users with large datasets but should generally complete

---

## 2026-01-29 - US-004

- Created `docs/research/websocket-audit.md` with comprehensive WebSocket audit
- Documented single `/ws` endpoint in api-server with echo/heartbeat functionality
- Found no production client code using WebSockets (feature is unused scaffolding)
- Recommended deletion (not migration) since no features depend on WebSocket
- Provided Supabase Realtime implementation patterns for when features are needed
- Included cost analysis (Supabase free tier: 200 connections, 100 msg/sec)
- Files changed: `docs/research/websocket-audit.md` (new file)
- **Learnings for future iterations:**
  - WebSocket implementation in api-server is unused—no client code connects to it
  - `@fastify/websocket` plugin registers with `maxPayload: 1MB` and `clientTracking: true`
  - Heartbeat is 30-second ping interval (server-initiated)
  - WebSocket tests are skipped in CI (require running server instance)
  - Supabase Realtime is already available—credentials exist in `.env.local.example`
  - When WebSockets are needed, prefer Supabase Realtime broadcast channels over custom implementation

---

## 2026-01-29 - US-003

- Created `docs/research/job-platform-recommendation.md` with comprehensive platform comparison
- Compared Inngest vs Vercel Cron + Redis across 8 criteria: developer experience, cost at scale, timeout handling, retry logic, observability, vendor lock-in, long-running jobs, event-driven triggers
- Clear recommendation: Inngest (with detailed rationale)
- Referenced both evaluation documents (inngest-evaluation.md, vercel-cron-kv-evaluation.md)
- Documented our specific requirements and how each platform meets them
- Included migration complexity comparison and cost-benefit analysis
- Files changed: `docs/research/job-platform-recommendation.md` (new file)
- **Learnings for future iterations:**
  - Speaker separation jobs (30+ min) are the deciding factor—Vercel Cron 800s limit is a hard blocker
  - Markdown linter (markdownlint) requires unique heading names—cannot use repeated "Inngest" / "Vercel Cron + Redis" as H4 subheadings under different H3 sections
  - Converting from sub-sub-headings to prose paragraphs satisfies linter while maintaining readability
  - Inngest's free tier (50K executions/month) likely covers our workload indefinitely
  - Engineering time for custom queue infrastructure (2-3 weeks) exceeds Inngest Pro cost for years

---

## 2026-01-29 - US-002

- Created `docs/research/vercel-cron-kv-evaluation.md` with comprehensive Vercel Cron + Upstash Redis evaluation
- Documented pros (native integration, simplicity, cost efficiency, unified billing)
- Documented cons (no retry logic, duration limits, manual queue complexity, Hobby once-per-day limit)
- Added cost analysis for Vercel Cron (free), Upstash Redis (free/paid tiers), and function execution
- Documented manual queue implementation approach with Redis data structures and visibility timeout pattern
- Documented cron pattern limitations (no named values, UTC only, no dynamic scheduling)
- Included complete code example for cron job with KV state management, retry logic, and job status endpoint
- Files changed: `docs/research/vercel-cron-kv-evaluation.md` (new file)
- **Learnings for future iterations:**
  - Vercel KV deprecated Dec 2024, now use Upstash Redis via Marketplace
  - Hobby plan cron jobs limited to once per day (expressions running more frequently fail deployment)
  - Hobby plan timing imprecision: ±59 minutes from scheduled time
  - Function max duration: 300s Hobby, 800s Pro/Enterprise (with Fluid Compute)
  - Cron jobs only run on production deployment (not preview environments)
  - Must implement own retry logic, deduplication, and concurrency control with Redis

---

## 2026-01-29 - US-001

- Created `docs/research/inngest-evaluation.md` with comprehensive Inngest evaluation
- Documented pros (Vercel integration, durable execution, TypeScript SDK, observability)
- Documented cons (1000 step limit, 32MB state limit, vendor lock-in)
- Added cost analysis comparing free tier vs Pro tier ($75/mo)
- Documented Vercel integration approach with project structure and code examples
- Documented step functions (step.run, step.sleep, step.waitForEvent, step.invoke, step.sendEvent)
- Included complete code example for news-analyzer job with retries
- Files changed: `docs/research/inngest-evaluation.md` (new file)
- **Learnings for future iterations:**
  - Inngest free tier covers 50K executions/month (likely sufficient for current workload)
  - Steps can run up to 2 hours each (bypasses Vercel's 10-60s limits)
  - Sleep can last up to 1 year on paid plans (7 days on free tier)
  - 1000 steps max per function requires thoughtful workflow design
  - 32MB total state limit includes events + step returns + metadata

---

## 2026-01-30 - US-014

- Updated GitHub Actions workflows to remove Render references:
  - `.github/workflows/preview-deploy.yml`:
    - Renamed `render-preview` label to `preview` (simpler naming)
    - Updated job names and step names to remove "render-preview"
    - Updated PR comment messages to say "Vercel" only, not "Vercel, Render"
  - `.github/workflows/preview-env-sync.yml`:
    - Removed `RENDER_API_KEY` environment variable from workflow
    - Updated label check from `render-preview` to `preview`
    - Updated workflow description comments (Supabase ↔ Vercel only)
    - Updated success PR comment to list only Supabase→Vercel syncs
- Verified no remaining Render references in any workflow files via grep
- Validated YAML syntax via gh workflow list (all workflows active)
- Typecheck passes
- Files changed:
  - `.github/workflows/preview-deploy.yml`
  - `.github/workflows/preview-env-sync.yml`
- **Learnings for future iterations:**
  - When renaming a label, update all workflow files that reference it
  - The preview-sync script (tooling/scripts/src/preview-sync/) still contains Render code—will be cleaned up in US-015
  - GitHub PR labels should use simple names; "render-preview" was named for legacy reasons

---

## 2026-01-30 - US-017

- Fastify packages were already removed from package.json files in US-016 (deleted api-server)
- Ran `pnpm install` to update lockfile—removed 11 unused packages
- Verified no Fastify imports remain in source code (grep for import/require patterns)
- Note: `fastify@5.6.2` remains in lockfile as transitive dependency:
  - Comes from `inngest` → `@opentelemetry/auto-instrumentations-node` → `@opentelemetry/instrumentation-fastify`
  - This is optional OpenTelemetry instrumentation, not a direct dependency
  - Our code does not import or use Fastify
- Files changed:
  - `pnpm-lock.yaml` (52 insertions, 238 deletions)
- **Learnings for future iterations:**
  - Transitive dependencies may remain in lockfile even after removing direct dependencies
  - Use `pnpm why <package>` to trace why a package is installed
  - OpenTelemetry auto-instrumentations include instrumentation for many frameworks (Express, Fastify, Hono, etc.)
  - The acceptance criteria "no fastify imports remain" refers to our source code, not transitive dependencies

---

## 2026-01-30 - US-020

- Updated `apps/web/.env.local.example` with missing environment variables:
  - Added `NEXT_PUBLIC_SUPABASE_URL` and `NEXT_PUBLIC_SUPABASE_ANON_KEY` for Supabase Realtime module (US-010/US-011)
  - Added `NEXT_PUBLIC_POSTHOG_KEY` and `NEXT_PUBLIC_POSTHOG_HOST` for PostHog analytics
- Render-related variables (API_SERVER_URL) were already removed in US-015
- Inngest variables (INNGEST_EVENT_KEY, INNGEST_SIGNING_KEY) were already added in US-006
- Typecheck passes
- Files changed:
  - `apps/web/.env.local.example` (8 insertions)
- **Learnings for future iterations:**
  - When adding new modules that use environment variables, update `.env.local.example` in the same story
  - Search codebase for `process.env.NEXT_PUBLIC_` to find undocumented public variables
  - PostHog was documented in CLAUDE.md but not in `.env.local.example`—check both locations

---
